if(!Mif){var Mif={}}if(!Mif.ids){Mif.ids={}}if(!Mif.id){Mif.id=function(a){return Mif.ids[a]}}Mif.Tree=new Class({version:"1.2.6.3",Implements:[new Events,new Options],options:{types:{},forest:false,animateScroll:true,height:18,expandTo:true},initialize:function(a){this.setOptions(a);$extend(this,{types:this.options.types,forest:this.options.forest,animateScroll:this.options.animateScroll,dfltType:this.options.dfltType,height:this.options.height,container:$(a.container),UID:++Mif.Tree.UID,key:{},expanded:[]});this.defaults={name:"",cls:"",openIcon:"mif-tree-empty-icon",closeIcon:"mif-tree-empty-icon",loadable:false,hidden:false};this.dfltState={open:false};this.$index=[];this.updateOpenState();if(this.options.expandTo){this.initExpandTo()}this.DOMidPrefix="mif-tree-";this.wrapper=new Element("div").addClass("mif-tree-wrapper").injectInside(this.container);this.events();this.initScroll();this.initSelection();this.initHover();this.addEvent("drawChildren",function(f){var d=f._toggle||[];for(var e=0,c=d.length;e<c;e++){d[e].drawToggle()}f._toggle=[]});var b=this.options.id;this.id=b;if(b!=null){Mif.ids[b]=this}if(MooTools.version>="1.2.2"&&this.options.initialize){this.options.initialize.call(this)}},bound:function(){Array.each(arguments,function(a){this.bound[a]=this[a].bind(this)},this)},events:function(){this.bound("mouse","mouseleave","mousedown","preventDefault","toggleClick","toggleDblclick","focus","blurOnClick","keyDown","keyUp");this.wrapper.addEvents({mousemove:this.bound.mouse,mouseover:this.bound.mouse,mouseout:this.bound.mouse,mouseleave:this.bound.mouseleave,mousedown:this.bound.mousedown,click:this.bound.toggleClick,dblclick:this.bound.toggleDblclick,selectstart:this.bound.preventDefault});this.container.addEvent("click",this.bound.focus);document.addEvent("click",this.bound.blurOnClick);document.addEvents({keydown:this.bound.keyDown,keyup:this.bound.keyUp})},blurOnClick:function(a){var b=a.target;while(b){if(b==this.container){return}b=b.parentNode}this.blur()},focus:function(){if(Mif.Focus&&Mif.Focus==this){return this}if(Mif.Focus){Mif.Focus.blur()}Mif.Focus=this;this.focused=true;this.container.addClass("mif-tree-focused");return this.fireEvent("focus")},blur:function(){Mif.Focus=null;if(!this.focused){return this}this.focused=false;this.container.removeClass("mif-tree-focused");return this.fireEvent("blur")},$getIndex:function(){this.$index=[];var b=this.forest?this.root.getFirst():this.root;var a=b;while(b){if(!(a.hidden&&a.contains(b))){if(!b.hidden){this.$index.push(b)}a=b}b=b._getNextVisible()}},preventDefault:function(a){a.preventDefault()},mousedown:function(a){if(a.rightClick){return}a.preventDefault();this.fireEvent("mousedown")},mouseleave:function(){this.mouse.coords={x:null,y:null};this.mouse.target=false;this.mouse.node=false;if(this.hover){this.hover()}},mouse:function(a){this.mouse.coords=this.getCoords(a);var b=this.getTarget(a);this.mouse.target=b.target;this.mouse.node=b.node},getTarget:function(d){var e=d.target,c;while(!(/mif-tree/).test(e.className)){e=e.parentNode}var g=e.className.match(/mif-tree-(gadjet)-[^n]|mif-tree-(icon)|mif-tree-(name)|mif-tree-(checkbox)/);if(!g){var f=this.mouse.coords.y;if(f==-1||!this.$index){c=false}else{c=this.$index[((f)/this.height).toInt()]}return{node:c,target:"node"}}for(var a=5;a>0;a--){if(g[a]){var b=g[a];break}}return{node:Mif.Tree.Nodes[e.getAttribute("uid")],target:b}},getCoords:function(c){var b=this.wrapper.getPosition();var a=c.page.x-b.x;var e=c.page.y-b.y;var d=this.wrapper;if((e-d.scrollTop>d.clientHeight)||(a-d.scrollLeft>d.clientWidth)){e=-1}return{x:a,y:e}},keyDown:function(a){this.key=a;this.key.state="down";if(this.focused){this.fireEvent("keydown",[a])}},keyUp:function(a){this.key={};this.key.state="up";if(this.focused){this.fireEvent("keyup",[a])}},toggleDblclick:function(a){var b=this.mouse.target;if(!(b=="name"||b=="icon")){return}this.mouse.node.toggle()},toggleClick:function(a){if(this.mouse.target!="gadjet"){return}this.mouse.node.toggle()},initScroll:function(){this.scroll=new Fx.Scroll(this.wrapper,{link:"cancel"})},scrollTo:function(c){var b=c.getVisiblePosition();var d=b*this.height;var a=(d<this.wrapper.scrollTop);var e=(d>(this.wrapper.scrollTop+this.wrapper.clientHeight-this.height));if(b==-1||(!a&&!e)){this.scroll.fireEvent("complete");return false}if(this.animateScroll){this.scroll.start(this.wrapper.scrollLeft,d-(e?this.wrapper.clientHeight-this.height:this.height))}else{this.scroll.set(this.wrapper.scrollLeft,d-(e?this.wrapper.clientHeight-this.height:this.height));this.scroll.fireEvent("complete")}return this},updateOpenState:function(){this.addEvents({drawChildren:function(d){var c=d.children;for(var b=0,a=c.length;b<a;b++){c[b].updateOpenState()}},drawRoot:function(){this.root.updateOpenState()}})},expandTo:function(a){if(!a){return this}var b=[];while(!a.isRoot()&&!(this.forest&&a.getParent().isRoot())){a=a.getParent();if(!a){break}b.unshift(a)}b.each(function(c){c.toggle(true)});return this},initExpandTo:function(){this.addEvent("loadChildren",function(d){if(!d){return}var c=d.children;for(var b=c.length;b--;){var e=c[b];if(e.expandTo){this.expanded.push(e)}}});function a(){this.expanded.each(function(b){this.expandTo(b)},this);this.expanded=[]}this.addEvents({load:a.bind(this),loadNode:a.bind(this)})}});Mif.Tree.UID=0;Array.implement({inject:function(c,d,a){var e=this.indexOf(d)+(a=="before"?0:1);for(var b=this.length-1;b>=e;b--){this[b+1]=this[b]}this[e]=c;return this}});Mif.Tree.Node=new Class({Implements:[Events],initialize:function(a,b){$extend(this,a);this.children=[];this.type=b.type||this.tree.dfltType;this.property=b.property||{};this.data=b.data;this.state=$extend($unlink(this.tree.dfltState),b.state);this.$calculate();this.UID=Mif.Tree.Node.UID++;Mif.Tree.Nodes[this.UID]=this;var c=this.id;if(c!=null){Mif.ids[c]=this}this.tree.fireEvent("nodeCreate",[this]);this._property=["id","name","cls","openIcon","closeIcon","openIconUrl","closeIconUrl","hidden"]},$calculate:function(){$extend(this,$unlink(this.tree.defaults));this.type=$splat(this.type);this.type.each(function(b){var a=this.tree.types[b];if(a){$extend(this,a)}},this);$extend(this,this.property);return this},getDOM:function(b){var a=$(this.tree.DOMidPrefix+this.UID);if(b=="node"){return a}var c=a.getFirst();if(b=="wrapper"){return c}if(b=="children"){return c.getNext()}return c.getElement(".mif-tree-"+b)},getGadjetType:function(){return(this.loadable&&!this.isLoaded())?"plus":(this.hasVisibleChildren()?(this.isOpen()?"minus":"plus"):"none")},toggle:function(c){if(this.state.open==c||this.$loading||this.$toggling){return this}var b=this.getParent();function a(d){this.state.open=!this.state.open;if(d=="drawed"){this.drawToggle()}else{b._toggle=(b._toggle||[])[this.state.open?"include":"erase"](this)}this.fireEvent("toggle",[this.state.open]);this.tree.fireEvent("toggle",[this,this.state.open]);return this}if(b&&!b.$draw){return a.apply(this,[])}if(this.loadable&&!this.state.loaded){if(!this.load_event){this.load_event=true;this.addEvent("load",function(){this.toggle()}.bind(this))}return this.load()}if(!this.hasChildren()){return this}return a.apply(this,["drawed"])},drawToggle:function(){this.tree.$getIndex();Mif.Tree.Draw.update(this)},recursive:function(b,a){a=$splat(a);if(b.apply(this,a)!==false){this.children.each(function(c){if(c.recursive(b,a)===false){return false}})}return this},isOpen:function(){return this.state.open},isLoaded:function(){return this.state.loaded},isLast:function(){if(this.parentNode==null||this.parentNode.children.getLast()==this){return true}return false},isFirst:function(){if(this.parentNode==null||this.parentNode.children[0]==this){return true}return false},isRoot:function(){return this.parentNode==null?true:false},getChildren:function(){return this.children},hasChildren:function(){return this.children.length?true:false},index:function(){if(this.isRoot()){return 0}return this.parentNode.children.indexOf(this)},getNext:function(){if(this.isLast()){return null}return this.parentNode.children[this.index()+1]},getPrevious:function(){if(this.isFirst()){return null}return this.parentNode.children[this.index()-1]},getFirst:function(){if(!this.hasChildren()){return null}return this.children[0]},getLast:function(){if(!this.hasChildren()){return null}return this.children.getLast()},getParent:function(){return this.parentNode},_getNextVisible:function(){var b=this;if(b.isRoot()){if(!b.isOpen()||!b.hasChildren(true)){return false}return b.getFirst(true)}else{if(b.isOpen()&&b.getFirst(true)){return b.getFirst(true)}else{var a=b;do{b=a.getNext(true);if(b){return b}a=a.parentNode}while(a);return false}}},getPreviousVisible:function(){var a=this.tree.$index.indexOf(this);return a==0?null:this.tree.$index[a-1]},getNextVisible:function(){var a=this.tree.$index.indexOf(this);return a<this.tree.$index.length-1?this.tree.$index[a+1]:null},getVisiblePosition:function(){return this.tree.$index.indexOf(this)},hasVisibleChildren:function(){if(!this.hasChildren()){return false}if(this.isOpen()){var a=this.getNextVisible();if(!a){return false}if(a.parentNode!=this){return false}return true}else{var b=this.getFirst();while(b){if(!b.hidden){return true}b=b.getNext()}return false}},isLastVisible:function(){var a=this.getNext();while(a){if(!a.hidden){return false}a=a.getNext()}return true},contains:function(a){while(a){if(a==this){return true}a=a.parentNode}return false},addType:function(a){return this.processType(a,"add")},removeType:function(a){return this.processType(a,"remove")},setType:function(a){return this.processType(a,"set")},processType:function(a,b){switch(b){case"add":this.type.include(a);break;case"remove":this.type.erase(a);break;case"set":this.type=a;break}var c={};this._property.each(function(d){c[d]=this[d]},this);this.$calculate();this._property.each(function(d){this.updateProperty(d,c[d],this[d])},this);return this},set:function(e){this.tree.fireEvent("beforeSet",[this,e]);var c=e.property||e||{};for(var d in c){var b=c[d];var a=this[d];this.updateProperty(d,a,b);this[d]=this.property[d]=b}this.tree.fireEvent("set",[this,e]);return this},updateProperty:function(a,c,g){if(g==c){return this}if(a=="id"){delete Mif.ids[c];if(g){Mif.ids[g]=this}return this}if(!Mif.Tree.Draw.isUpdatable(this)){return this}switch(a){case"name":this.getDOM("name").set("html",g);return this;case"cls":this.getDOM("wrapper").removeClass(c).addClass(g);return this;case"openIcon":case"closeIcon":this.getDOM("icon").removeClass(c).addClass(g);return this;case"openIconUrl":case"closeIconUrl":var h=this.getDOM("icon");h.setStyle("background-image","none");if(g){h.setStyle("background-image","url("+g+")")}return this;case"hidden":this.getDOM("node").setStyle("display",g?"none":"block");var f=this.getPreviousVisible();var b=this.getNextVisible();var i=this.getParent();this[a]=this.property[a]=g;this.tree.$getIndex();var e=this.getPreviousVisible();var d=this.getNextVisible();[f,b,e,d,i,this].each(function(j){Mif.Tree.Draw.update(j)});return this}return this},updateOpenState:function(){if(this.state.open){this.state.open=false;this.toggle()}}});Mif.Tree.Node.UID=0;Mif.Tree.Nodes={};Mif.Tree.Draw={getHTML:function(b,a){var d=b.tree.DOMidPrefix;var c;if($defined(b.state.checked)){if(!b.hasCheckbox){b.state.checked="nochecked"}c='<span class="mif-tree-checkbox mif-tree-node-'+b.state.checked+'" uid="'+b.UID+'">'+Mif.Tree.Draw.zeroSpace+"</span>"}else{c=""}a=a||[];a.push('<div class="mif-tree-node ',(b.isLast()?"mif-tree-node-last":""),'"'+(b.hidden?' style="display:none"':"")+' id="',d,b.UID,'">','<span class="mif-tree-node-wrapper ',b.cls,(b.state.selected?" mif-tree-node-selected":""),'" uid="',b.UID,'">','<span class="mif-tree-gadjet mif-tree-gadjet-',b.getGadjetType(),'" uid="',b.UID,'">',Mif.Tree.Draw.zeroSpace,"</span>",c,'<span class="mif-tree-icon ',(b.closeIconUrl?'" style="background-image: url('+b.closeIconUrl+')" ':b.closeIcon+'"'),' uid="',b.UID,'">',Mif.Tree.Draw.zeroSpace,"</span>",'<span class="mif-tree-name" uid="',b.UID,'">',b.name,"</span>","</span>",'<div class="mif-tree-children" style="display:none"></div>',"</div>");return a},children:function(f,b){f.open=true;f.$draw=true;var e=[];var d=f.children;for(var c=0,a=d.length;c<a;c++){this.getHTML(d[c],e)}b=b||f.getDOM("children");b.set("html",e.join(""));f.tree.fireEvent("drawChildren",[f])},root:function(b){var a=this.node(b.root);a.inject(b.wrapper);b.$draw=true;b.fireEvent("drawRoot")},forestRoot:function(a){var b=new Element("div").addClass("mif-tree-children-root").injectInside(a.wrapper);Mif.Tree.Draw.children(a.root,b)},node:function(a){return new Element("div").set("html",this.getHTML(a).join("")).getFirst()},isUpdatable:function(a){if((!a||!a.tree)||(a.getParent()&&!a.getParent().$draw)||(a.isRoot()&&(!a.tree.$draw||a.tree.forest))){return false}return true},update:function(b){if(!this.isUpdatable(b)){return null}if(!b.hasChildren()){b.state.open=false}b.getDOM("gadjet").className="mif-tree-gadjet mif-tree-gadjet-"+b.getGadjetType();if(b.closeIconUrl){b.getDOM("icon").setStyle("background-image","url("+(b.isOpen()?b.openIconUrl:b.closeIconUrl)+")")}else{b.getDOM("icon").className="mif-tree-icon "+b[b.isOpen()?"openIcon":"closeIcon"]}b.getDOM("node")[(b.isLastVisible()?"add":"remove")+"Class"]("mif-tree-node-last");if(b.$loading){return null}var a=b.getDOM("children");if(b.isOpen()){if(!b.$draw){Mif.Tree.Draw.children(b)}a.style.display="block"}else{a.style.display="none"}b.tree.fireEvent("updateNode",b);return b},inject:function(d,b){if(!this.isUpdatable(d)){return}b=b||d.getDOM("node")||this.node(d);var c=d.getPrevious();if(c){b.injectAfter(c.getDOM("node"));return}var a;if(d.tree.forest&&d.parentNode.isRoot()){a=d.tree.wrapper.getElement(".mif-tree-children-root")}else{if(d.tree.root==d){a=d.tree.wrapper}else{a=d.parentNode.getDOM("children")}}b.inject(a,"top")}};Mif.Tree.Draw.zeroSpace=Browser.Engine.trident?"&shy;":(Browser.Engine.webkit?"&#8203":"");Mif.Tree.implement({initSelection:function(){this.defaults.selectClass="";this.wrapper.addEvent("mousedown",this.attachSelect.bindWithEvent(this))},attachSelect:function(b){if(!["icon","name","node"].contains(this.mouse.target)){return}var a=this.mouse.node;if(!a){return}this.select(a)},select:function(a){if(!a){return this}var b=this.selected;if(b==a){return this}if(b){b.select(false);this.fireEvent("unSelect",[b]).fireEvent("selectChange",[b,false])}this.selected=a;a.select(true);this.fireEvent("select",[a]).fireEvent("selectChange",[a,true]);return this},unselect:function(){var a=this.selected;if(!a){return this}this.selected=false;a.select(false);this.fireEvent("unSelect",[a]).fireEvent("selectChange",[a,false]);return this},getSelected:function(){return this.selected},isSelected:function(a){return a.isSelected()}});Mif.Tree.Node.implement({select:function(a){this.state.selected=a;if(!Mif.Tree.Draw.isUpdatable(this)){return}var b=this.getDOM("wrapper");b[(a?"add":"remove")+"Class"](this.selectClass||"mif-tree-node-selected")},isSelected:function(){return this.state.selected}});Mif.Tree.implement({initHover:function(){this.defaults.hoverClass="";this.wrapper.addEvent("mousemove",this.hover.bind(this));this.wrapper.addEvent("mouseout",this.hover.bind(this));this.defaultHoverState={gadjet:false,checkbox:false,icon:false,name:false,node:false};this.hoverState=$unlink(this.defaultHoverState)},hover:function(){var b=this.mouse.node;var a=this.mouse.target;$each(this.hoverState,function(c,e,d){if(c==b&&(e=="node"||e==a)){return}if(c){Mif.Tree.Hover.out(c,e);d[e]=false;this.fireEvent("hover",[c,e,"out"])}if(b&&(e=="node"||e==a)){Mif.Tree.Hover.over(b,e);d[e]=b;this.fireEvent("hover",[b,e,"over"])}else{d[e]=false}},this)},updateHover:function(){this.hoverState=$unlink(this.defaultHoverState);this.hover()}});Mif.Tree.Hover={over:function(a,b){var c=a.getDOM("wrapper");c.addClass((a.hoverClass||"mif-tree-hover")+"-"+b);if(a.state.selected){c.addClass((a.hoverClass||"mif-tree-hover")+"-selected-"+b)}},out:function(a,b){var c=a.getDOM("wrapper");c.removeClass((a.hoverClass||"mif-tree-hover")+"-"+b).removeClass((a.hoverClass||"mif-tree-hover")+"-selected-"+b)}};Mif.Tree.Load={children:function(c,d,a){for(var b=c.length;b--;){var g=c[b];var f=g.children;var e=new Mif.Tree.Node({tree:a,parentNode:d||undefined},g);if(a.forest||d!=undefined){d.children.unshift(e)}else{a.root=e}if(f&&f.length){arguments.callee(f,e,a)}}if(d){d.state.loaded=true}a.fireEvent("loadChildren",d)}};Mif.Tree.implement({load:function(b){var a=this;this.loadOptions=this.loadOptions||$lambda({});function c(d){var e=null;if(a.forest){a.root=new Mif.Tree.Node({tree:a,parentNode:null},{});e=a.root}Mif.Tree.Load.children(d,e,a);Mif.Tree.Draw[a.forest?"forestRoot":"root"](a);a.$getIndex();a.fireEvent("load");return a}b=$extend($extend({isSuccess:$lambda(true),secure:true,onSuccess:c,method:"get"},this.loadOptions()),b);if(b.json){return c(b.json)}new Request.JSON(b).send();return this}});Mif.Tree.Node.implement({load:function(b){this.$loading=true;b=b||{};this.addType("loader");var a=this;function c(d){Mif.Tree.Load.children(d,a,a.tree);delete a.$loading;a.state.loaded=true;a.removeType("loader");Mif.Tree.Draw.update(a);a.fireEvent("load");a.tree.fireEvent("loadNode",a);return a}b=$extend($extend($extend({isSuccess:$lambda(true),secure:true,onSuccess:c,method:"get"},this.tree.loadOptions(this)),this.loadOptions),b);if(b.json){return c(b.json)}new Request.JSON(b).send();return this}});Mif.Tree.KeyNav=new Class({initialize:function(a){this.tree=a;this.bound={action:this.action.bind(this),attach:this.attach.bind(this),detach:this.detach.bind(this)};a.addEvents({focus:this.bound.attach,blur:this.bound.detach})},attach:function(){var a=Browser.Engine.trident||Browser.Engine.webkit?"keydown":"keypress";document.addEvent(a,this.bound.action)},detach:function(){var a=Browser.Engine.trident||Browser.Engine.webkit?"keydown":"keypress";document.removeEvent(a,this.bound.action)},action:function(b){if(!["down","left","right","up","pgup","pgdown","end","home"].contains(b.key)){return}var a=this.tree;if(!a.selected){a.select(a.forest?a.root.getFirst():a.root)}else{var c=a.selected;switch(b.key){case"down":this.goForward(c);b.stop();break;case"up":this.goBack(c);b.stop();break;case"left":this.goLeft(c);b.stop();break;case"right":this.goRight(c);b.stop();break;case"home":this.goStart(c);b.stop();break;case"end":this.goEnd(c);b.stop();break;case"pgup":this.goPageUp(c);b.stop();break;case"pgdown":this.goPageDown(c);b.stop();break}}a.scrollTo(a.selected)},goForward:function(b){var a=b.getNextVisible();if(a){this.tree.select(a)}},goBack:function(b){var a=b.getPreviousVisible();if(a){this.tree.select(a)}},goLeft:function(a){if(a.isRoot()){if(a.isOpen()){a.toggle()}else{return false}}else{if(a.hasChildren(true)&&a.isOpen()){a.toggle()}else{if(a.tree.forest&&a.getParent().isRoot()){return false}return this.tree.select(a.getParent())}}return true},goRight:function(a){if(!a.hasChildren(true)&&!a.loadable){return false}else{if(!a.isOpen()){return a.toggle()}else{return this.tree.select(a.getFirst(true))}}},goStart:function(){this.tree.select(this.tree.$index[0])},goEnd:function(){this.tree.select(this.tree.$index.getLast())},goPageDown:function(d){var a=this.tree;var c=(a.container.clientHeight/a.height).toInt()-1;var b=Math.min(a.$index.indexOf(d)+c,a.$index.length-1);a.select(a.$index[b])},goPageUp:function(d){var a=this.tree;var c=(a.container.clientHeight/a.height).toInt()-1;var b=Math.max(a.$index.indexOf(d)-c,0);a.select(a.$index[b])}});Event.Keys.extend({pgdown:34,pgup:33,home:36,end:35});Mif.Tree.implement({initSortable:function(a){this.sortable=true;this.sortFunction=a||function(c,b){if(c.name>b.name){return 1}else{if(c.name<b.name){return -1}else{return 0}}};this.addEvent("loadChildren",function(b){if(b){b.sort()}});this.addEvent("structureChange",function(e,d,b,c){e.sort()});return this}});Mif.Tree.Node.implement({sort:function(a){this.children.sort(a||this.tree.sortFunction);return this}});Mif.Tree.Node.implement({inject:function(d,f,e){f=f||"inside";var h=this.parentNode;function b(k){var j=k;while(j){j=j.getPrevious();if(!j){return null}if(!j.hidden){return j}}return null}var c=b(this);var g=e?"copy":"move";switch(f){case"after":case"before":if(d["get"+(f=="after"?"Next":"Previous")]()==this){return false}if(this.parentNode){this.parentNode.children.erase(this)}this.parentNode=d.parentNode;this.parentNode.children.inject(this,d,f);break;case"inside":if(d.tree&&d.getLast()==this){return false}if(this.parentNode){this.parentNode.children.erase(this)}if(d.tree){if(!d.hasChildren()){d.$draw=true;d.state.open=true}d.children.push(this);this.parentNode=d}else{d.root=this;this.parentNode=null;d.fireEvent("drawRoot")}break}var i=d.tree||d;if(this==this.tree.root){this.tree.root=false}if(this.tree!=i){var a=this.tree;this.recursive(function(){this.tree=i})}i.fireEvent("structureChange",[this,d,f,g]);i.$getIndex();if(a){a.$getIndex()}Mif.Tree.Draw.inject(this,e);[d,this,h,c,b(this)].each(function(j){Mif.Tree.Draw.update(j)});return this},copy:function(c,a){if(this.copyDenied){return this}function d(f){var i=f.node;var e=f.tree;var g=$unlink({property:i.property,type:i.type,state:i.state,data:i.data});g.state.open=false;var h=new Mif.Tree.Node({parentNode:f.parentNode,children:[],tree:e},g);i.children.each(function(k){var j=d({node:k,parentNode:h,tree:e});h.children.push(j)});return h}var b=d({node:this,parentNode:null,tree:c.tree});return b.inject(c,a,Mif.Tree.Draw.node(b))},remove:function(){if(this.removeDenied){return}this.tree.fireEvent("remove",[this]);var a=this.parentNode,b=this.getPreviousVisible();if(a){a.children.erase(this)}else{if(!this.tree.forest){this.tree.root=null}}this.tree.selected=false;this.getDOM("node").destroy();this.tree.$getIndex();Mif.Tree.Draw.update(a);Mif.Tree.Draw.update(b);this.recursive(function(){if(this.id){delete Mif.ids[this.id]}});this.tree.mouse.node=false;this.tree.updateHover()}});Mif.Tree.implement({move:function(c,b,a){if(c.inject(b,a)){this.fireEvent("move",[c,b,a])}return this},copy:function(d,c,a){var b=d.copy(c,a);if(b){this.fireEvent("copy",[d,c,a,b])}return this},remove:function(a){a.remove();return this},add:function(b,c,a){if(!(b instanceof Mif.Tree.Node)){b=new Mif.Tree.Node({parentNode:null,tree:this},b)}b.inject(c,a,Mif.Tree.Draw.node(b));this.fireEvent("add",[b,c,a]);return this}});Mif.Tree.Drag=new Class({Implements:[new Events,new Options],Extends:Drag,options:{group:"tree",droppables:[],snap:4,animate:true,open:600,scrollDelay:100,scrollSpeed:100,modifier:"control",startPlace:["icon","name"],allowContainerDrop:true},initialize:function(a,b){a.drag=this;this.setOptions(b);$extend(this,{tree:a,snap:this.options.snap,groups:[],droppables:[],action:this.options.action});this.addToGroups(this.options.group);this.setDroppables(this.options.droppables);$extend(a.defaults,{dropDenied:[],dragDisabled:false});a.addEvent("drawRoot",function(){a.root.dropDenied.combine(["before","after"])});this.pointer=new Element("div").addClass("mif-tree-pointer").injectInside(a.wrapper);this.current=Mif.Tree.Drag.current;this.target=Mif.Tree.Drag.target;this.where=Mif.Tree.Drag.where;this.element=[this.current,this.target,this.where];this.document=a.wrapper.getDocument();this.selection=(Browser.Engine.trident)?"selectstart":"mousedown";this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),eventStop:$lambda(false),leave:this.leave.bind(this),enter:this.enter.bind(this),keydown:this.keydown.bind(this)};this.attach();this.addEvent("start",function(){Mif.Tree.Drag.dropZone=this;this.tree.unselect();document.addEvent("keydown",this.bound.keydown);this.setDroppables();this.droppables.each(function(c){c.getElement().addEvents({mouseleave:this.bound.leave,mouseenter:this.bound.enter})},this);Mif.Tree.Drag.current.getDOM("name").addClass("mif-tree-drag-current");this.addGhost()},true);this.addEvent("complete",function(){document.removeEvent("keydown",this.bound.keydown);this.droppables.each(function(d){d.getElement().removeEvent("mouseleave",this.bound.leave).removeEvent("mouseenter",this.bound.enter)},this);Mif.Tree.Drag.current.getDOM("name").removeClass("mif-tree-drag-current");var c=Mif.Tree.Drag.dropZone;if(!c||c.where=="notAllowed"){Mif.Tree.Drag.startZone.onstop();Mif.Tree.Drag.startZone.emptydrop();return}if(c.onstop){c.onstop()}c.beforeDrop()})},getElement:function(){return this.tree.wrapper},addToGroups:function(a){a=$splat(a);this.groups.combine(a);a.each(function(b){Mif.Tree.Drag.groups[b]=(Mif.Tree.Drag.groups[b]||[]).include(this)},this)},setDroppables:function(a){this.droppables.combine($splat(a));this.groups.each(function(b){this.droppables.combine(Mif.Tree.Drag.groups[b])},this)},attach:function(){this.tree.wrapper.addEvent("mousedown",this.bound.start);return this},detach:function(){this.tree.wrapper.removeEvent("mousedown",this.bound.start);return this},dragTargetSelect:function(){function b(){this.current.getDOM("name").addClass("mif-tree-drag-current")}function a(){this.current.getDOM("name").removeClass("mif-tree-drag-current")}this.addEvent("start",b.bind(this));this.addEvent("beforeComplete",a.bind(this))},leave:function(b){var c=Mif.Tree.Drag.dropZone;if(c){c.where="notAllowed";Mif.Tree.Drag.ghost.firstChild.className="mif-tree-ghost-icon mif-tree-ghost-"+c.where;if(c.onleave){c.onleave()}Mif.Tree.Drag.dropZone=false}var a=this.getZone(b.relatedTarget);if(a){this.enter(null,a)}},onleave:function(){this.tree.unselect();this.clean();$clear(this.scrolling);this.scrolling=null;this.target=false},enter:function(b,a){if(b){a=this.getZone(b.target)}var c=Mif.Tree.Drag.dropZone;if(c&&c.onleave){c.onleave()}Mif.Tree.Drag.dropZone=a;a.current=Mif.Tree.Drag.current;if(a.onenter){a.onenter()}},onenter:function(){this.onleave()},getZone:function(d){if(!d){return false}var c=$(d);do{for(var b=this.droppables.length;b--;){var a=this.droppables[b];if(c==a.getElement()){return a}}c=c.getParent()}while(c);return false},keydown:function(b){if(b.key=="esc"){var a=Mif.Tree.Drag.dropZone;if(a){a.where="notAllowed"}this.stop(b)}},autoScroll:function(){var f=this.y;if(f==-1){return}var e=this.tree.wrapper;var c=f-e.scrollTop;var b=e.offsetHeight-c;var a=0;var d;if(c<this.tree.height){d=c;a=1}else{if(b<this.tree.height){d=b;a=-1}}if(a&&!this.scrolling){this.scrolling=function(g){if(f!=this.y){f=this.y;d=(a==1?(f-e.scrollTop):(e.offsetHeight-f+e.scrollTop))||1}e.scrollTop=e.scrollTop-a*this.options.scrollSpeed/d}.periodical(this.options.scrollDelay,this,[a])}if(!a){$clear(this.scrolling);this.scrolling=null}},start:function(a){if(a.rightClick){return}if(this.options.preventDefault){a.preventDefault()}this.fireEvent("beforeStart",this.element);var b=this.tree.mouse.target;if(!b){return}this.current=$splat(this.options.startPlace).contains(b)?this.tree.mouse.node:false;if(!this.current||this.current.dragDisabled){return}Mif.Tree.Drag.current=this.current;Mif.Tree.Drag.startZone=this;this.mouse={start:a.page};this.document.addEvents({mousemove:this.bound.check,mouseup:this.bound.cancel});this.document.addEvent(this.selection,this.bound.eventStop)},drag:function(a){Mif.Tree.Drag.ghost.position({x:a.page.x+20,y:a.page.y+20});var b=Mif.Tree.Drag.dropZone;if(!b||!b.ondrag){return}Mif.Tree.Drag.dropZone.ondrag(a)},ondrag:function(b){this.autoScroll();if(!this.checkTarget()){return}this.clean();var a=this.where;var d=this.target;var e=a;if(a=="after"&&d&&(d.getNext())||a=="before"&&d.getPrevious()){e="between"}Mif.Tree.Drag.ghost.firstChild.className="mif-tree-ghost-icon mif-tree-ghost-"+e;if(a=="notAllowed"){this.tree.unselect();return}if(d&&d.tree){this.tree.select(d)}if(a=="inside"){if(d.tree&&!d.isOpen()&&!this.openTimer&&(d.loadable||d.hasChildren())){this.wrapper=d.getDOM("wrapper").setStyle("cursor","progress");this.openTimer=function(){d.toggle();this.clean()}.delay(this.options.open,this)}}else{var f=this.tree.wrapper;var c=this.index*this.tree.height;if(a=="after"){c+=this.tree.height}this.pointer.setStyles({left:f.scrollLeft,top:c,width:f.clientWidth})}},clean:function(){this.pointer.style.width=0;if(this.openTimer){$clear(this.openTimer);this.openTimer=false;this.wrapper.style.cursor="inherit";this.wrapper=false}},addGhost:function(){var b=this.current.getDOM("wrapper");var a=new Element("span").addClass("mif-tree-ghost");a.adopt(Mif.Tree.Draw.node(this.current).getFirst()).injectInside(document.body).addClass("mif-tree-ghost-notAllowed").setStyle("position","absolute");new Element("span").set("html",Mif.Tree.Draw.zeroSpace).injectTop(a);a.getLast().getFirst().className="";Mif.Tree.Drag.ghost=a},checkTarget:function(){this.y=this.tree.mouse.coords.y;var b=this.tree.mouse.node;if(!b){if(this.options.allowContainerDrop&&(this.tree.forest||!this.tree.root)){this.target=this.tree.$index.getLast();this.index=this.tree.$index.length-1;if(this.index==-1){this.where="inside";this.target=this.tree.root||this.tree}else{this.where="after"}}else{this.target=false;this.where="notAllowed"}this.fireEvent("drag");return true}if((this.current instanceof Mif.Tree.Node)&&this.current.contains(b)){this.target=b;this.where="notAllowed";this.fireEvent("drag");return true}this.index=Math.floor(this.y/this.tree.height);var d=this.y-this.index*this.tree.height;var c=b.dropDenied;if(this.tree.sortable){c.include("before").include("after")}var a;if(!c.contains("inside")&&d>(this.tree.height/4)&&d<(3/4*this.tree.height)){a="inside"}else{if(d<this.tree.height/2){if(c.contains("before")){if(c.contains("inside")){a=c.contains("after")?"notAllowed":"after"}else{a="inside"}}else{a="before"}}else{if(c.contains("after")){if(c.contains("inside")){a=c.contains("before")?"notAllowed":"before"}else{a="inside"}}else{a="after"}}}if(this.where==a&&this.target==b){return false}this.where=a;this.target=b;this.fireEvent("drag");return true},emptydrop:function(){var e=this.current,d=this.target,c=this.where;var a=this.tree.scroll;var b=function(){a.removeEvent("complete",b);if(this.options.animate){var g=e.getDOM("wrapper");var f=g.getPosition();Mif.Tree.Drag.ghost.set("morph",{duration:"short",onComplete:function(){Mif.Tree.Drag.ghost.dispose();this.fireEvent("emptydrop",this.element)}.bind(this)});Mif.Tree.Drag.ghost.morph({left:f.x,top:f.y});return}Mif.Tree.Drag.ghost.dispose();this.fireEvent("emptydrop",this.element);return}.bind(this);a.addEvent("complete",b);this.tree.select(this.current);this.tree.scrollTo(this.current)},beforeDrop:function(){if(this.options.beforeDrop){this.options.beforeDrop.apply(this,[this.current,this.target,this.where])}else{this.drop()}},drop:function(){var e=this.current,d=this.target,a=this.where;Mif.Tree.Drag.ghost.dispose();var c=this.action||(this.tree.key[this.options.modifier]?"copy":"move");if(this.where=="inside"&&d.tree&&!d.isOpen()){if(d.tree){d.toggle()}if(d.$loading){var b=function(){this.tree[c](e,d,a);this.tree.select(e).scrollTo(e);this.fireEvent("drop",[e,d,a]);d.removeEvent("load",b)};d.addEvent("load",b);return}}if(!(e instanceof Mif.Tree.Node)){e=e.toNode(this.tree)}this.tree[c](e,d,a);this.tree.select(e).scrollTo(e);this.fireEvent("drop",[e,d,a])},onstop:function(){this.clean();$clear(this.scrolling)}});Mif.Tree.Drag.groups={};Mif.Tree.Drag.Element=new Class({Implements:[Options,Events],initialize:function(b,a){this.element=$(b);this.setOptions(a)},getElement:function(){return this.element},onleave:function(){this.where="notAllowed";Mif.Tree.Drag.ghost.firstChild.className="mif-tree-ghost-icon mif-tree-ghost-"+this.where},onenter:function(){this.where="inside";Mif.Tree.Drag.ghost.firstChild.className="mif-tree-ghost-icon mif-tree-ghost-"+this.where},beforeDrop:function(){if(this.options.beforeDrop){this.options.beforeDrop.apply(this,[this.current,this.trarget,this.where])}else{this.drop()}},drop:function(){Mif.Tree.Drag.ghost.dispose();this.fireEvent("drop",Mif.Tree.Drag.current)}});Mif.Tree.implement({attachRenameEvents:function(){this.wrapper.addEvents({click:function(a){if($(a.target).get("tag")=="input"){return}this.beforeRenameComplete()}.bind(this),keydown:function(a){if(a.key=="enter"){this.beforeRenameComplete()}if(a.key=="esc"){this.renameCancel()}}.bind(this)})},disableEvents:function(){if(!this.eventStorage){this.eventStorage=new Element("div")}this.eventStorage.cloneEvents(this.wrapper);this.wrapper.removeEvents()},enableEvents:function(){this.wrapper.removeEvents();this.wrapper.cloneEvents(this.eventStorage)},getInput:function(){if(!this.input){this.input=new Element("input").addClass("mif-tree-rename");this.input.addEvent("focus",function(){this.select()}).addEvent("click",function(a){a.stop()});Mif.Tree.Rename.autoExpand(this.input)}return this.input},startRename:function(b){this.focus();this.unselect();this.disableEvents();this.attachRenameEvents();var a=this.getInput();a.value=b.name;this.renameName=b.getDOM("name");this.renameNode=b;a.setStyle("width",this.renameName.offsetWidth+15);a.replaces(this.renameName);a.focus()},finishRename:function(){this.renameName.replaces(this.getInput())},beforeRenameComplete:function(){if(this.options.beforeRename){var a=this.getInput().value;var b=this.renameNode;this.options.beforeRename.apply(this,[b,b.name,a])}else{this.renameComplete()}},renameComplete:function(){this.enableEvents();this.finishRename();var b=this.renameNode;var a=b.name;b.set({property:{name:this.getInput().value}});this.fireEvent("rename",[b,b.name,a]);this.select(b)},renameCancel:function(){this.enableEvents();this.finishRename();this.select(this.renameNode)}});Mif.Tree.Node.implement({rename:function(){if(this.property.renameDenied){return}this.tree.startRename(this)}});Mif.Tree.Rename={autoExpand:function(a){var b=new Element("span").addClass("mif-tree-rename").setStyles({position:"absolute",left:-2000,top:0,padding:0}).injectInside(document.body);a.addEvent("keydown",function(c){(function(){a.setStyle("width",Math.max(20,b.set("html",a.value.replace(/\s/g,"&nbsp;")).offsetWidth+15))}).delay(10)})}};Mif.Tree.implement({initCheckbox:function(a){this.checkboxType=a||"simple";this.dfltState.checked="unchecked";this.defaults.hasCheckbox=true;this.wrapper.addEvent("click",this.checkboxClick.bind(this));if(this.checkboxType=="simple"){return}this.addEvent("loadChildren",function(b){if(!b){return}if(b.state.checked=="checked"){b.recursive(function(){this.state.checked="checked"})}else{b.getFirst().setParentCheckbox(1)}})},checkboxClick:function(a){if(this.mouse.target!="checkbox"){return}this.mouse.node["switch"]()},getChecked:function(a){var b=[];this.root.recursive(function(){var c=a?this.state.checked!=="unchecked":this.state.checked=="checked";if(this.hasCheckbox&&c){b.push(this)}});return b}});Mif.Tree.Node.implement({"switch":function(c){if(this.state.checked==c||!this.hasCheckbox){return this}var a=this.tree.checkboxType;var b=(this.state.checked=="checked")?"unchecked":"checked";if(a=="simple"){this.setCheckboxState(b);this.tree.fireEvent(b=="checked"?"check":"unCheck",this);this.tree.fireEvent("switch",[this,(b=="checked"?true:false)]);return this}this.recursive(function(){this.setCheckboxState(b)});this.setParentCheckbox();this.tree.fireEvent(b=="checked"?"check":"unCheck",this);this.tree.fireEvent("switch",[this,(b=="checked"?true:false)]);return this},setCheckboxState:function(b){if(!this.hasCheckbox){return}var a=this.state.checked;this.state.checked=b;if((!this.parentNode&&this.tree.$draw)||(this.parentNode&&this.parentNode.$draw)){this.getDOM("checkbox").removeClass("mif-tree-node-"+a).addClass("mif-tree-node-"+b)}},setParentCheckbox:function(e){if(!this.hasCheckbox||!this.parentNode||(this.tree.forest&&!this.parentNode.parentNode)){return}var d=this.parentNode;var f="";var c=d.children;for(var b=c.length;b--;b>0){var g=c[b];if(!g.hasCheckbox){continue}var a=g.state.checked;if(a=="partially"){f="partially";break}else{if(a=="checked"){if(f=="unchecked"){f="partially";break}f="checked"}else{if(f=="checked"){f="partially";break}else{f="unchecked"}}}}if(d.state.checked==f||(e&&f=="partially"&&d.state.checked=="checked")){return}d.setCheckboxState(f);d.setParentCheckbox(e)}});Mif.Tree.CookieStorage=new Class({Implements:[Options],options:{store:function(a){return a.property.id},retrieve:function(a){return Mif.id(a)},event:"toggle",action:"toggle"},initialize:function(a,b){this.setOptions(b);this.tree=a;this.cookie=new Cookie("mif.tree:"+this.options.event+a.id||"");this.nodes=[];this.initSave()},write:function(){this.cookie.write(JSON.encode(this.nodes))},read:function(){return JSON.decode(this.cookie.read())||[]},restore:function(f){if(!f){this.restored=this.restored||this.read()}var d=f||this.restored;for(var b=0,a=d.length;b<a;b++){var c=d[b];var e=this.options.retrieve(c);if(e){e[this.options.action](true);d.erase(c);a--}}return d},initSave:function(){this.tree.addEvent(this.options.event,function(a,c){var b=this.options.store(a);if(c){this.nodes.include(b)}else{this.nodes.erase(b)}this.write()}.bind(this))}});